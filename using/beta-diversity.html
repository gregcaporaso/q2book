
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>9. Beta diversity &#8212; q2book</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e7340bb3dbd8dde6db86f25597f54a1b.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10. Normalization of Feature Tables" href="feature-table-normalization.html" />
    <link rel="prev" title="8. Alpha diversity" href="alpha-diversity.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">q2book</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../front-matter/preface.html">
   Preface
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Front Matter
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../front-matter/reading.html">
   1. Reading this book
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Microbiome Bioinformatics with QIIME 2
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="getting-started.html">
   1. Getting started with using QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="interactive-introduction.html">
   2. An interactive introduction to QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metadata.html">
   3. Metadata in QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="importing.html">
   4. Importing data into QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="demultiplexing.html">
   5. Demultiplexing a sequencing run
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="denoising.html">
   6. Denoising demultiplexed sequencing data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="taxonomy.html">
   7. Taxonomic annotation and analysis of sequences
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="alpha-diversity.html">
   8. Alpha diversity
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   9. Beta diversity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="feature-table-normalization.html">
   10. Normalization of Feature Tables
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Understanding the algorithms
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../algorithms/pairwise-alignment.html">
   1. Pairwise sequence alignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../algorithms/database-searching.html">
   2. Sequence homology searching
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../algorithms/machine-learning.html">
   3. Machine learning in bioinformatics
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Developing with QIIME 2
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../developing/getting-started.html">
   1. Getting started with developing with QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../developing/first-plugin.html">
   2. Building a first plugin
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Back Matter
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/importing-examples.html">
   1. Appendix: Examples illustrating importing data into QIIME 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/biological-information.html">
   2. Appendix: Biological Information
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/advanced-metadata-formatting.html">
   3. Appendix: Advanced metadata formatting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/microbiome-methods.html">
   4. Appendix: A brief introduction to methods in microbiome science
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/q2-origin-story.html">
   5. Appendix: History of the QIIME platform
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../back-matter/glossary.html">
   6. Glossary
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/using/beta-diversity.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/using/beta-diversity.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/gregcaporaso/q2book/main?urlpath=tree/book/using/beta-diversity.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distances-and-distance-matrices">
   9.1. Distances and distance matrices
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#jaccard-distance">
     9.1.1. Jaccard Distance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#bray-curtis-dissimilarity">
     9.1.2. Bray-Curtis dissimilarity
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unweighted-unifrac-distance">
     9.1.3. Unweighted UniFrac distance
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conceptual-overview-of-unweighted-unifrac">
       9.1.3.1. Conceptual overview of Unweighted UniFrac
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#worked-example-of-unweighted-unifrac">
       9.1.3.2. Worked example of Unweighted UniFrac
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weighted-unifrac-distance">
     9.1.4. Weighted UniFrac distance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interpreting-distance-matrices">
   9.2. Interpreting distance matrices
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distribution-plots-and-comparisons">
     9.2.1. Distribution plots and comparisons
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hierarchical-clustering">
     9.2.2. Hierarchical clustering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ordination">
     9.2.3. Ordination
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#list-of-works-cited">
   9.3. List of works cited
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="beta-diversity">
<span id="id1"></span><h1><span class="section-number">9. </span>Beta diversity<a class="headerlink" href="#beta-diversity" title="Permalink to this headline">¶</a></h1>
<p>In this chapter we’ll continue our exploration of metrics of microbiome diversity. We’ll next discuss metrics of <strong>beta diversity</strong>, which are measures of “between-sample” diversity. I think of these as metrics that are computed based on pairs of samples.</p>
<p>The beta diversity metrics that we’ll cover in this chapter are distance and dissimilarity metrics. These are always computed on a pair of samples, and most typically they will be computed on all pairs of samples in a feature table. If a distance is computed between a pair of samples, it results in a single positive value. If distances are computed between all pairs of samples, the result is a distance matrix. The distance matrix is indexed by sample ids on both axes, and individual distances can be looked up from that matrix.</p>
<div class="section" id="distances-and-distance-matrices">
<h2><span class="section-number">9.1. </span>Distances and distance matrices<a class="headerlink" href="#distances-and-distance-matrices" title="Permalink to this headline">¶</a></h2>
<p>The distance between two samples is the opposite of the similarity between two samples, so if two samples have a large distance between them that means they are more dissimilar to one another. If they have a small distance between them, that means they are similar to one another. Distances between microbiome samples typically aren’t interpreted in isolation, but rather contextualized by other distances.</p>
<p>The meaning of a distance between samples depends on the specific distance metric that is being used. Stepping back from biology for a moment, imagine that we’re computing the distance between two cities. There are various ways that we could measure this, and the way we choose to measure it depends on what we need to do with that distance. For example, we could draw a straight line between the two cities on a map, measure that line, and we’d have a distance between the cities. But, if we’re driving between the cities, that distance won’t be very relevant unless there is a road that connects the cities by the line that we’ve drawn. In this case, a more relevant distance will be that of the shortest drivable route between the two cities. Just as there are many ways to compute the distance between two cities, there are many ways to compute the distance between biological communities.</p>
<p>Because distances between microbiome samples are generally contextualized by other distances between microbiome samples, we generally compute distances between all pairs of samples at the same time. We can then work with the full distance matrix, or look up distances for specific pairs of samples that we’re interested in from the distance matrix. Here’s an example of a feature table, and a distance matrix containing Jaccard distances between three samples. (We’ll learn about Jaccard distances later in this chapter.)</p>
<p>A feature table:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skbio</span>

<span class="kn">import</span> <span class="nn">qiime2</span>
<span class="kn">import</span> <span class="nn">qiime2.plugins.feature_table</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">import</span> <span class="nn">qiime2.plugins.diversity</span> <span class="k">as</span> <span class="nn">div</span>

<span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;4ac2&#39;</span><span class="p">,</span> <span class="s1">&#39;e375&#39;</span><span class="p">,</span> <span class="s1">&#39;4gd8&#39;</span><span class="p">]</span>
<span class="n">feature_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">,</span><span class="s1">&#39;B2&#39;</span><span class="p">,</span><span class="s1">&#39;B3&#39;</span><span class="p">,</span><span class="s1">&#39;B4&#39;</span><span class="p">,</span><span class="s1">&#39;B5&#39;</span><span class="p">,</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span><span class="s1">&#39;E2&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                 <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]])</span>

<span class="n">feature_table_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_ids</span><span class="p">)</span>
<span class="n">feature_table_1a</span> <span class="o">=</span> <span class="n">qiime2</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="s2">&quot;FeatureTable[Frequency]&quot;</span><span class="p">,</span> <span class="n">feature_table_1</span><span class="p">)</span>
<span class="n">rarefied_feature_table_1a</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">rarefy</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">feature_table_1a</span><span class="p">,</span> <span class="n">sampling_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">rarefied_table</span>

<span class="n">rarefied_feature_table_1</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">style</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
</style><table id="T_39032574_9c9b_11eb_92b9_000d3a543a7d" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >B1</th>        <th class="col_heading level0 col1" >B2</th>        <th class="col_heading level0 col2" >B3</th>        <th class="col_heading level0 col3" >B4</th>        <th class="col_heading level0 col4" >B5</th>        <th class="col_heading level0 col5" >A1</th>        <th class="col_heading level0 col6" >E2</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_39032574_9c9b_11eb_92b9_000d3a543a7dlevel0_row0" class="row_heading level0 row0" >4ac2</th>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col0" class="data row0 col0" >3</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col1" class="data row0 col1" >5</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col2" class="data row0 col2" >2</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col3" class="data row0 col3" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col4" class="data row0 col4" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col5" class="data row0 col5" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow0_col6" class="data row0 col6" >0</td>
            </tr>
            <tr>
                        <th id="T_39032574_9c9b_11eb_92b9_000d3a543a7dlevel0_row1" class="row_heading level0 row1" >e375</th>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col0" class="data row1 col0" >1</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col1" class="data row1 col1" >4</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col2" class="data row1 col2" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col3" class="data row1 col3" >3</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col4" class="data row1 col4" >2</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col5" class="data row1 col5" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow1_col6" class="data row1 col6" >0</td>
            </tr>
            <tr>
                        <th id="T_39032574_9c9b_11eb_92b9_000d3a543a7dlevel0_row2" class="row_heading level0 row2" >4gd8</th>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col0" class="data row2 col0" >2</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col1" class="data row2 col1" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col2" class="data row2 col2" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col3" class="data row2 col3" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col4" class="data row2 col4" >0</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col5" class="data row2 col5" >4</td>
                        <td id="T_39032574_9c9b_11eb_92b9_000d3a543a7drow2_col6" class="data row2 col6" >4</td>
            </tr>
    </tbody></table></div></div>
</div>
<p>A distance matrix containing Jaccard distances between all pairs of samples in the feature table:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jaccard_1a</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">rarefied_feature_table_1a</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;jaccard&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distance_matrix</span>
<span class="n">jaccard_1</span> <span class="o">=</span> <span class="n">jaccard_1a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">skbio</span><span class="o">.</span><span class="n">DistanceMatrix</span><span class="p">)</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
<span class="n">jaccard_1</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/share/miniconda/envs/q2book/lib/python3.6/site-packages/sklearn/metrics/pairwise.py:1761: DataConversionWarning: Data was converted to boolean for metric jaccard
  warnings.warn(msg, DataConversionWarning)
</pre></div>
</div>
<div class="output text_html"><style  type="text/css" >
</style><table id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7d" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >4ac2</th>        <th class="col_heading level0 col1" >e375</th>        <th class="col_heading level0 col2" >4gd8</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7dlevel0_row0" class="row_heading level0 row0" >4ac2</th>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow0_col0" class="data row0 col0" >0.00</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow0_col1" class="data row0 col1" >0.60</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow0_col2" class="data row0 col2" >0.80</td>
            </tr>
            <tr>
                        <th id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7dlevel0_row1" class="row_heading level0 row1" >e375</th>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow1_col0" class="data row1 col0" >0.60</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow1_col1" class="data row1 col1" >0.00</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow1_col2" class="data row1 col2" >0.83</td>
            </tr>
            <tr>
                        <th id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7dlevel0_row2" class="row_heading level0 row2" >4gd8</th>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow2_col0" class="data row2 col0" >0.80</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow2_col1" class="data row2 col1" >0.83</td>
                        <td id="T_39100b2c_9c9b_11eb_92b9_000d3a543a7drow2_col2" class="data row2 col2" >0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
<p>Ignoring for the moment exactly how these values are calculated, let discuss what this distance matrix tells us. To find the distance between any pair of samples, look up the first sample id of the pair on one axis, and the other sample id of the pair on the other axis.</p>
<p>First, notice that the diagonal of the matrix is all zeros. This is because the distance between a sample and itself (for example between <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">4ac2</span></code>) is always zero by definition.</p>
<p>Next, notice that the matrix is symmetric: if you flip the values across the diagonal they are identical. In other words, if you look up the value at the intersection of row <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and column <code class="docutils literal notranslate"><span class="pre">4gd8</span></code>, the value will be the same as at the intersection of column <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and row <code class="docutils literal notranslate"><span class="pre">4gd8</span></code>. This tells you that the distance between two samples is the same regardless of the order the samples are provided when you compute the distance between them.</p>
<p>Finally, notice that all values in our matrix are zero or greater. Negative distances between samples don’t exist.</p>
<p>This distance matrix tells us that the most similar pair of samples in our feature table are <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code>. The most dissimilar samples in our feature table are <code class="docutils literal notranslate"><span class="pre">4gd8</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code>. To understand exactly what these distances mean, let’s explore a few of the commonly used metrics.</p>
<div class="section" id="jaccard-distance">
<h3><span class="section-number">9.1.1. </span>Jaccard Distance<a class="headerlink" href="#jaccard-distance" title="Permalink to this headline">¶</a></h3>
<p>The first beta diversity metric that we’ll look at is Jaccard Distance. This metric derives from set theory, and is the inverse of the Jaccard Index (or Jaccard Similarity). It is defined as follows:</p>
<div class="math notranslate nohighlight" id="equation-jaccard-index">
<span class="eqno">(9.1)<a class="headerlink" href="#equation-jaccard-index" title="Permalink to this equation">¶</a></span>\[Jaccard \, Index_{(A,B)} = \frac{| A \cap B |}{| A \cup B |}\]</div>
<div class="math notranslate nohighlight" id="equation-jaccard-distance">
<span class="eqno">(9.2)<a class="headerlink" href="#equation-jaccard-distance" title="Permalink to this equation">¶</a></span>\[Jaccard \, Distance_{(A,B)} = 1 - Jaccard \, Index_{(A,B)}\]</div>
<p>To compute the Jaccard Index for a pair of samples <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, count all of the features that are observed in <em>both</em> <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. <em>Observed</em> features in this context are features with a count of greater than zero. The features present in both samples represent the <strong>intersection</strong> of <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. In set theory notation <span class="math notranslate nohighlight">\(A \cap B\)</span> denotes the intersection of sets <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, and <span class="math notranslate nohighlight">\(| A \cap B |\)</span> denotes the size of the intersection of sets <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. Computing this for samples <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code> from the feature table above would look like the following:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_a_id</span> <span class="o">=</span> <span class="s1">&#39;4ac2&#39;</span>
<span class="n">sample_b_id</span> <span class="o">=</span> <span class="s1">&#39;e375&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample A id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sample_a_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample B id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sample_b_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">sample_a_vector</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">sample_a_id</span><span class="p">]</span>
<span class="n">sample_b_vector</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">sample_b_id</span><span class="p">]</span>
<span class="n">feature_ids</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>

<span class="n">observed_features_a</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">observed_features_b</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
      <span class="k">if</span> <span class="n">sample_a_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">observed_features_a</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feature_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">sample_b_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">observed_features_b</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feature_ids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">a_b_intersection</span> <span class="o">=</span> <span class="n">observed_features_a</span> <span class="o">&amp;</span> <span class="n">observed_features_b</span>
<span class="n">a_b_intersection_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_b_intersection</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; A = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">observed_features_a</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; B = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">observed_features_b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; A ∩ B = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">a_b_intersection</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; | A ∩ B | = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">a_b_intersection_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sample A id: 4ac2
Sample B id: e375

 A = {&#39;B2&#39;, &#39;B1&#39;, &#39;B3&#39;}
 B = {&#39;B2&#39;, &#39;B1&#39;, &#39;B5&#39;, &#39;B4&#39;}

 A ∩ B = {&#39;B2&#39;, &#39;B1&#39;}
 | A ∩ B | = 2
</pre></div>
</div>
</div>
</div>
<p>Next, count the features that are observed in <em>either</em> sample <span class="math notranslate nohighlight">\(A\)</span> or sample <span class="math notranslate nohighlight">\(B\)</span> or in both sample <span class="math notranslate nohighlight">\(A\)</span> and sample <span class="math notranslate nohighlight">\(B\)</span>. Those features represent the <strong>union</strong> of the samples. In set theory notation <span class="math notranslate nohighlight">\(| A \cup B |\)</span> denotes the size of the union of sets <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_b_union</span> <span class="o">=</span> <span class="n">observed_features_a</span> <span class="o">|</span> <span class="n">observed_features_b</span>
<span class="n">a_b_union_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_b_union</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; A ∪ B = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">a_b_union</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; | A ∪ B | = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">a_b_union_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> A ∪ B = {&#39;B2&#39;, &#39;B4&#39;, &#39;B1&#39;, &#39;B5&#39;, &#39;B3&#39;}
 | A ∪ B | = 5
</pre></div>
</div>
</div>
</div>
<p>Next, divide the size of the intersection by the size the union of the two samples to get the Jaccard Index between the two samples <a class="reference internal" href="#equation-jaccard-index">(9.1)</a>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">j_index</span> <span class="o">=</span> <span class="n">a_b_intersection_size</span> <span class="o">/</span> <span class="n">a_b_union_size</span>
<span class="n">j_distance</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j_index</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;( </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> ) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a_b_intersection_size</span><span class="p">,</span> <span class="n">a_b_union_size</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jaccard index between samples </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">: </span><span class="si">%1.2f</span><span class="s1"> &#39;</span> <span class="o">%</span>\
       <span class="p">(</span><span class="n">sample_a_id</span><span class="p">,</span> <span class="n">sample_b_id</span><span class="p">,</span> <span class="n">j_index</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>( 2 / 5 ) 
Jaccard index between samples 4ac2 and e375: 0.40 
</pre></div>
</div>
</div>
</div>
<p>Subtract the Jaccard Index from one to get the Jaccard Distance <a class="reference internal" href="#equation-jaccard-distance">(9.2)</a>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1 - </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">j_index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jaccard distance between samples </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">: </span><span class="si">%1.2f</span><span class="s1"> &#39;</span> <span class="o">%</span>\
       <span class="p">(</span><span class="n">sample_a_id</span><span class="p">,</span> <span class="n">sample_b_id</span><span class="p">,</span> <span class="n">j_distance</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 - 0.40
Jaccard distance between samples 4ac2 and e375: 0.60 
</pre></div>
</div>
</div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Return to the example presented above and try to compute the Jaccard distances between all pairs of samples yourself. Confirm that you get these values after rounding to two decimal places.</p>
</div>
</div>
<div class="section" id="bray-curtis-dissimilarity">
<h3><span class="section-number">9.1.2. </span>Bray-Curtis dissimilarity<a class="headerlink" href="#bray-curtis-dissimilarity" title="Permalink to this headline">¶</a></h3>
<p>The next metric that we’ll look at is called Bray-Curtis dissimilarity. The Bray-Curtis dissimilarity between a pair of samples, <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, is defined as follows:</p>
<div class="math notranslate nohighlight" id="equation-bray-curtis-dissimilarity">
<span class="eqno">(9.3)<a class="headerlink" href="#equation-bray-curtis-dissimilarity" title="Permalink to this equation">¶</a></span>\[Bray\text{-}Curtis\,Dissimilarity_{AB} = \frac{ \sum_{i} | A_{i} - B_{i}|} {\sum_{i} (A_{i} + B_{i})}\]</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In <a class="reference internal" href="#equation-bray-curtis-dissimilarity">(9.3)</a>, the <span class="math notranslate nohighlight">\(|\,|\)</span> symbols indicate absolute value. This differs from <a class="reference internal" href="#equation-jaccard-distance">(9.2)</a>, where the <span class="math notranslate nohighlight">\(|\,|\)</span> symbols indicate the size of a set.</p>
</div>
</div>
<p><span class="math notranslate nohighlight">\(i\)</span> : a feature in the input feature table</p>
<p><span class="math notranslate nohighlight">\(A_{i}\)</span> : the value (i.e., frequency or count) of feature <span class="math notranslate nohighlight">\(i\)</span> in sample <span class="math notranslate nohighlight">\(A\)</span></p>
<p><span class="math notranslate nohighlight">\(B_{i}\)</span> : the value (i.e., frequency or count) of feature <span class="math notranslate nohighlight">\(i\)</span> in sample <span class="math notranslate nohighlight">\(B\)</span></p>
<p>This formula is relatively straight-forward to apply. To compute the numerator of the equation, sum the absolute differences of each feature’s count across samples <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. Computing this for samples <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code> would look like the following:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_a_id</span> <span class="o">=</span> <span class="s1">&#39;4ac2&#39;</span>
<span class="n">sample_b_id</span> <span class="o">=</span> <span class="s1">&#39;e375&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample A id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sample_a_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sample B id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sample_b_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">sample_a_vector</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">sample_a_id</span><span class="p">]</span>
<span class="n">sample_b_vector</span> <span class="o">=</span> <span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">sample_b_id</span><span class="p">]</span>
<span class="n">numerator_value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| </span><span class="si">%d</span><span class="s1"> - </span><span class="si">%d</span><span class="s1"> |&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_a_vector</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sample_b_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="n">numerator_value</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sample_a_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_b_vector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Numerator value: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">numerator_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sample A id: 4ac2
Sample B id: e375

| 3 - 1 | + | 5 - 4 | + | 2 - 0 | + | 0 - 3 | + | 0 - 2 | + | 0 - 0 | + | 0 - 0 |
Numerator value: 10
</pre></div>
</div>
</div>
</div>
<p>To compute the denominator of the equation, sum each feature’s count across samples <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>. Computing this for samples <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code> would look like the following:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">denominator_value</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; + &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;( </span><span class="si">%d</span><span class="s1"> + </span><span class="si">%d</span><span class="s1"> )&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_a_vector</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sample_b_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="n">denominator_value</span> <span class="o">+=</span> <span class="n">sample_a_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sample_b_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Denominator value: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">denominator_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>( 3 + 1 ) + ( 5 + 4 ) + ( 2 + 0 ) + ( 0 + 3 ) + ( 0 + 2 ) + ( 0 + 0 ) + ( 0 + 0 )
Denominator value: 20
</pre></div>
</div>
</div>
</div>
<p>Finally, divide the numerator by the denominator to get the Bray-Curtis dissimilarity between the samples:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bc</span> <span class="o">=</span> <span class="n">numerator_value</span> <span class="o">/</span> <span class="n">denominator_value</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numerator_value</span><span class="p">,</span> <span class="n">denominator_value</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bray-Curtis dissimilarity between samples </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">: </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_a_id</span><span class="p">,</span> <span class="n">sample_b_id</span><span class="p">,</span> <span class="n">bc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 10 / 20 
Bray-Curtis dissimilarity between samples 4ac2 and e375: 0.50
</pre></div>
</div>
</div>
</div>
<p>Computing Bray-Curtis dissimilarities between all pairs of samples in our feature table would result in the following distance matrix:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bray_curtis_1a</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">rarefied_feature_table_1a</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;braycurtis&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distance_matrix</span>
<span class="n">bray_curtis_1</span> <span class="o">=</span> <span class="n">bray_curtis_1a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">skbio</span><span class="o">.</span><span class="n">DistanceMatrix</span><span class="p">)</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
<span class="n">bray_curtis_1</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
</style><table id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7d" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >4ac2</th>        <th class="col_heading level0 col1" >e375</th>        <th class="col_heading level0 col2" >4gd8</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7dlevel0_row0" class="row_heading level0 row0" >4ac2</th>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow0_col0" class="data row0 col0" >0.00</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow0_col1" class="data row0 col1" >0.50</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow0_col2" class="data row0 col2" >0.80</td>
            </tr>
            <tr>
                        <th id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7dlevel0_row1" class="row_heading level0 row1" >e375</th>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow1_col0" class="data row1 col0" >0.50</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow1_col1" class="data row1 col1" >0.00</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow1_col2" class="data row1 col2" >0.90</td>
            </tr>
            <tr>
                        <th id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7dlevel0_row2" class="row_heading level0 row2" >4gd8</th>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow2_col0" class="data row2 col0" >0.80</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow2_col1" class="data row2 col1" >0.90</td>
                        <td id="T_3928cbbc_9c9b_11eb_92b9_000d3a543a7drow2_col2" class="data row2 col2" >0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
</div>
<div class="section" id="unweighted-unifrac-distance">
<h3><span class="section-number">9.1.3. </span>Unweighted UniFrac distance<a class="headerlink" href="#unweighted-unifrac-distance" title="Permalink to this headline">¶</a></h3>
<p>Just as some metrics of alpha diversity use a phylogenetic tree, some metrics of beta diversity also use a phylogenetic tree. The most widely applied phylogenetic beta diversity metric as of this writing is likely Unweighted UniFrac <span id="id2">[<a class="reference internal" href="#id27"><span>LK05</span></a>]</span>. Unweighted UniFrac is closely related to the alpha diversity metric, <a class="reference internal" href="alpha-diversity.html#faith-pd"><span class="std std-ref">Faith’s Phylogenetic Diversity index</span></a>, and it is computed similarly. First, for each sample <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span>, the branches connecting the observed features to the root node of the tree are identified. The Unweighted UniFrac distance is then computed as the branch length that is unique to either sample <span class="math notranslate nohighlight">\(A\)</span> or sample <span class="math notranslate nohighlight">\(B\)</span>, divided by all of the branch length covered by both samples.</p>
<p>The Unweighted UniFrac distance between a pair of samples <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> is defined as follows:</p>
<div class="math notranslate nohighlight" id="equation-unweighted-unifrac">
<span class="eqno">(9.4)<a class="headerlink" href="#equation-unweighted-unifrac" title="Permalink to this equation">¶</a></span>\[Unweighted\,UniFrac_{AB} = \frac{unique\,branch\,length}{observed\,branch\,length}\]</div>
<div class="section" id="conceptual-overview-of-unweighted-unifrac">
<h4><span class="section-number">9.1.3.1. </span>Conceptual overview of Unweighted UniFrac<a class="headerlink" href="#conceptual-overview-of-unweighted-unifrac" title="Permalink to this headline">¶</a></h4>
<p>To illustrate how UniFrac distances are computed, before we get into actually computing them, let’s look at a few examples. In these examples, imagine that we’re determining the pairwise UniFrac distance between two samples: Sample 1 which we’ll illustrate in red, and Sample 2 which we’ll illustrate in blue. The evolutionary relationships between all of the features in the samples (amplicon sequence variants (ASVs) in this example), are represented with a <strong>phylogram</strong> (a phylogenetic tree where branch lengths are computed from observed differences between features, such as number of differences between DNA sequences in a <a class="reference internal" href="../algorithms/pairwise-alignment.html#pairwise-alignment"><span class="std std-ref">pairwise alignment</span></a>). The count of each ASV in each sample appears to the right of the feature in the phylogenetic tree. As far as Unweighted UniFrac is concerned, a feature is observed in a sample if its count is greater than zero.</p>
<p>To compute the UniFrac distance between a pair of samples, we need to sum the branch length that was observed only in a single sample (the <em>unique</em> branch length), and sum the branch length that was observed in either or both samples (the <em>observed</em> branch length). Branch length that is unique to Sample 1 will be colored red, branch length that is unique to Sample 2 will be colored blue, and branch length that is observed in both samples will be colored purple. Unobserved branch length is colored black (as are the vertical lines in the tree, as those don’t contribute to branch length - they are purely for visual presentation).</p>
<div class="figure align-default" id="unifrac-tree-1">
<img alt="../_images/unifrac-tree-1.png" src="../_images/unifrac-tree-1.png" />
<p class="caption"><span class="caption-number">Fig. 9.1 </span><span class="caption-text">Phylogram and feature table indicating which features (amplicon sequence variants or ASVs) are present in each of two samples. This example illustrates an Unweighted UniFrac distance of zero between the two samples.</span><a class="headerlink" href="#unifrac-tree-1" title="Permalink to this image">¶</a></p>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition-attribution admonition">
<p class="admonition-title">Attribution</p>
<p>Phylogram figures in this section (such as <a class="reference internal" href="#unifrac-tree-1"><span class="std std-numref">Fig. 9.1</span></a>) were created by <a class="reference external" href="https://forum.qiime2.org/u/ebolyen/">&#64;ebolyen</a> using code he developed that is available <a class="reference external" href="https://gist.github.com/ebolyen/99e1010cc9a84fbca661e42313c77f61">here</a>.</p>
</div>
</div>
<p>In <a class="reference internal" href="#unifrac-tree-1"><span class="std std-numref">Fig. 9.1</span></a>, all of the ASVs that are observed in either sample are observed in both samples. As a result, the unique branch length in this case is zero, so we have a UniFrac distance of 0 between Sample 1 and Sample 2.</p>
<div class="figure align-default" id="unifrac-tree-3">
<img alt="../_images/unifrac-tree-3.png" src="../_images/unifrac-tree-3.png" />
<p class="caption"><span class="caption-number">Fig. 9.2 </span><span class="caption-text">Phylogram and feature table indicating which features (amplicon sequence variants or ASVs) are present in each of two samples. This example illustrates an Unweighted UniFrac distance of one between the two samples.</span><a class="headerlink" href="#unifrac-tree-3" title="Permalink to this image">¶</a></p>
</div>
<p>On the other end of the spectrum, in <a class="reference internal" href="#unifrac-tree-3"><span class="std std-numref">Fig. 9.2</span></a>, all of the ASVs in the tree are observed either in Sample 1 or Sample 2, but not in both samples. Furthermore, the ASVs observed in each sample are segregated into different clades in the phylogenetic tree such that there is no overlapping branch length at all. The unique branch length is therefore equal to the observed branch length, so we have a UniFrac distance of 1 between Sample A and Sample B.</p>
<div class="figure align-default" id="unifrac-tree-2">
<img alt="../_images/unifrac-tree-2.png" src="../_images/unifrac-tree-2.png" />
<p class="caption"><span class="caption-number">Fig. 9.3 </span><span class="caption-text">Phylogram and feature table indicating which features (amplicon sequence variants or ASVs) are present in each of two samples. This example illustrates an Unweighted UniFrac distance of approximately 0.5 between the two samples. The <code class="docutils literal notranslate"><span class="pre">*</span></code> indicates a branch length that is observed in both samples because descendant ASVs are observed in both samples.</span><a class="headerlink" href="#unifrac-tree-2" title="Permalink to this image">¶</a></p>
</div>
<p>In most cases, our samples are somewhere between these extremes, as represented in <a class="reference internal" href="#unifrac-tree-2"><span class="std std-numref">Fig. 9.3</span></a>. In this tree, some of our branch length is unique, and some is not. For example, ASV.5 is only observed in Sample 1, so the terminal branch leading to ASV.5 is red. ASV.4 is only observed in Sample 2, so the terminal branch leading to ASV.4 is blue. However, the last internal branch that leads to both ASV.5 and ASV.4 (annotated with <code class="docutils literal notranslate"><span class="pre">*</span></code>) is observed in both samples because ASVs in that lineage (ASV.5 and ASV.4) are observed in both samples. That branch is therefore colored purple. In this case, we have an intermediate UniFrac distance between Sample 1 and Sample 2, perhaps somewhere around 0.5.</p>
</div>
<div class="section" id="worked-example-of-unweighted-unifrac">
<h4><span class="section-number">9.1.3.2. </span>Worked example of Unweighted UniFrac<a class="headerlink" href="#worked-example-of-unweighted-unifrac" title="Permalink to this headline">¶</a></h4>
<p>Now let’s compute Unweighted UniFrac on our example feature table. We’ll work with the same phylogenetic tree that we used when computing <a class="reference internal" href="alpha-diversity.html#faith-pd"><span class="std std-ref">Faith’s Phylogenetic Diversity</span></a>. I’ll work through computing Unweighted UniFrac between samples <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">e375</span></code>. Follow along with this computation, and then try computing Unweighted UniFrac distances between <code class="docutils literal notranslate"><span class="pre">4ac2</span></code> and <code class="docutils literal notranslate"><span class="pre">4gd8</span></code>, and then between <code class="docutils literal notranslate"><span class="pre">e375</span></code> and <code class="docutils literal notranslate"><span class="pre">4gd8</span></code>. I’ll present the full distance matrix at the end of this section so you check your answers.</p>
<div class="figure align-default" id="bdiv-tree-1">
<img alt="../_images/adiv-tree-1.png" src="../_images/adiv-tree-1.png" />
<p class="caption"><span class="caption-number">Fig. 9.4 </span><span class="caption-text">A phylogenetic tree representing all of the features in our original feature table. (This tree isn’t intended to accurately represent the relationship between the Bacteria, Archaea, and Eukarya.)</span><a class="headerlink" href="#bdiv-tree-1" title="Permalink to this image">¶</a></p>
</div>
<p>Here’s the feature table again for convenience:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rarefied_feature_table_1</span><span class="o">.</span><span class="n">style</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
</style><table id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7d" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >B1</th>        <th class="col_heading level0 col1" >B2</th>        <th class="col_heading level0 col2" >B3</th>        <th class="col_heading level0 col3" >B4</th>        <th class="col_heading level0 col4" >B5</th>        <th class="col_heading level0 col5" >A1</th>        <th class="col_heading level0 col6" >E2</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7dlevel0_row0" class="row_heading level0 row0" >4ac2</th>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col0" class="data row0 col0" >3</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col1" class="data row0 col1" >5</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col2" class="data row0 col2" >2</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col3" class="data row0 col3" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col4" class="data row0 col4" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col5" class="data row0 col5" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow0_col6" class="data row0 col6" >0</td>
            </tr>
            <tr>
                        <th id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7dlevel0_row1" class="row_heading level0 row1" >e375</th>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col0" class="data row1 col0" >1</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col1" class="data row1 col1" >4</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col2" class="data row1 col2" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col3" class="data row1 col3" >3</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col4" class="data row1 col4" >2</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col5" class="data row1 col5" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow1_col6" class="data row1 col6" >0</td>
            </tr>
            <tr>
                        <th id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7dlevel0_row2" class="row_heading level0 row2" >4gd8</th>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col0" class="data row2 col0" >2</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col1" class="data row2 col1" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col2" class="data row2 col2" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col3" class="data row2 col3" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col4" class="data row2 col4" >0</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col5" class="data row2 col5" >4</td>
                        <td id="T_392a82d6_9c9b_11eb_92b9_000d3a543a7drow2_col6" class="data row2 col6" >4</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">skbio.tree</span> <span class="kn">import</span> <span class="n">TreeNode</span>

<span class="n">tree_1n</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;((B1:0.1,B2:0.05):0.1,((B3:0.05,B4:0.1):0.1,B5:0.2):0.1,&#39;</span>
                   <span class="s1">&#39;((A1:0.1,A2:0.05):0.3,&#39;</span>
                   <span class="s1">&#39;(E1:0.1,E2:0.1):0.7):0.25);&#39;</span><span class="p">)</span>

<span class="n">tree_1</span> <span class="o">=</span> <span class="n">TreeNode</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tree_1n</span><span class="p">)</span>
<span class="n">tree_1</span> <span class="o">=</span> <span class="n">tree_1</span><span class="o">.</span><span class="n">root_at_midpoint</span><span class="p">()</span>

<span class="n">tree_1a</span> <span class="o">=</span> <span class="n">qiime2</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="s2">&quot;Phylogeny[Rooted]&quot;</span><span class="p">,</span> <span class="n">tree_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To compute Unweighted UniFrac by hand, I recommend taking a similar approach to the one that you used for computing Faith’s Phylogenetic Diversity by hand. Print the phylogenetic tree <a class="reference internal" href="#bdiv-tree-1"><span class="std std-numref">Fig. 9.4</span></a>, and get two colored pens. This time, for each of the two features, trace the branches from the observed tips to the root of the tree in a different color for each sample. As a reminder, if you sum those branch lengths of each color, each sum will be the Faith’s Phylogenetic Diversity for the corresponding sample.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_observed_nodes</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Observed branch lengths for sample </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sample_id</span><span class="p">)</span>
        
    <span class="n">sample_vector</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]</span>
    <span class="n">observed_features</span> <span class="o">=</span> <span class="n">sample_vector</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">sample_vector</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">observed_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    
    <span class="c1"># iterate over the observed features</span>
    <span class="k">for</span> <span class="n">feature_id</span> <span class="ow">in</span> <span class="n">observed_features</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">feature_id</span><span class="p">)</span>
        <span class="n">observed_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">internal_node</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">internal_node</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># we&#39;ve hit the root</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">internal_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">observed_nodes</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">internal_node</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">observed_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">internal_node</span><span class="p">)</span>
    <span class="n">faith_pd</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">observed_nodes</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Faith&#39;s Phylogenetic Diversity of sample </span><span class="si">%s</span><span class="s2">: </span><span class="si">%1.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">faith_pd</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">observed_nodes</span>

<span class="n">sample_id1</span> <span class="o">=</span> <span class="s1">&#39;4ac2&#39;</span>
<span class="n">sample_id2</span> <span class="o">=</span> <span class="s1">&#39;e375&#39;</span>

<span class="n">observed_nodes1</span> <span class="o">=</span> <span class="n">get_observed_nodes</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="n">rarefied_feature_table_1</span><span class="p">,</span> <span class="n">sample_id1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">observed_nodes2</span> <span class="o">=</span> <span class="n">get_observed_nodes</span><span class="p">(</span><span class="n">tree_1</span><span class="p">,</span> <span class="n">rarefied_feature_table_1</span><span class="p">,</span> <span class="n">sample_id2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observed branch lengths for sample 4ac2
B1 0.1 0.1 0.25 0.125 
B2 0.05 
B3 0.05 0.1 0.1 
Faith&#39;s Phylogenetic Diversity of sample 4ac2: 0.88

Observed branch lengths for sample e375
B1 0.1 0.1 0.25 0.125 
B2 0.05 
B4
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 0.1 0.1 0.1 
B5 0.2 
Faith&#39;s Phylogenetic Diversity of sample e375: 1.12
</pre></div>
</div>
</div>
</div>
<p>To compute Unweighted UniFrac, you’ll distinguish between branches that are traced in different ways. First, all of the branches that are colored (in either or both of your colors) are your <strong>Observed Branches</strong>. In the phylograms above (e.g., <a class="reference internal" href="#unifrac-tree-2"><span class="std std-numref">Fig. 9.3</span></a>), the purple, blue, and red branches are the observed branches. The lengths of the observed branches are summed to give your <strong>Observed branch length</strong>. Each branch length should be included in the sum only one time.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observed_branches</span> <span class="o">=</span> <span class="n">observed_nodes1</span> <span class="o">|</span> <span class="n">observed_nodes2</span>
<span class="n">observed_branch_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">observed_branches</span><span class="p">]</span>
<span class="n">observed_branch_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">observed_branch_lengths</span><span class="p">)</span>    

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observed branch lengths = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">observed_branch_lengths</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sum of observed branch lengths: </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">observed_branch_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observed branch lengths = [0.2, 0.05, 0.125, 0.1, 0.1, 0.25, 0.05, 0.1, 0.1, 0.1]
Sum of observed branch lengths: 1.18
</pre></div>
</div>
</div>
</div>
<p>Next, the branches that are colored in only one of the two colors are your <strong>Unique Branches</strong>. In the phylograms above (e.g., <a class="reference internal" href="#unifrac-tree-2"><span class="std std-numref">Fig. 9.3</span></a>), the blue and red branches are the unique branches. The lengths of the unique branches are summed to give your <strong>Unique branch length</strong>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shared_branches</span> <span class="o">=</span> <span class="n">observed_nodes1</span> <span class="o">&amp;</span> <span class="n">observed_nodes2</span>
<span class="n">unique_branches</span> <span class="o">=</span> <span class="n">observed_branches</span> <span class="o">-</span> <span class="n">shared_branches</span>
<span class="n">unique_branch_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">unique_branches</span><span class="p">]</span>
<span class="n">unique_branch_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">unique_branch_lengths</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unique branch lengths = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_branch_lengths</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sum of unique branch lengths: </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">unique_branch_length</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unique branch lengths = [0.05, 0.2, 0.1]
Sum of unique branch lengths: 0.35
</pre></div>
</div>
</div>
</div>
<p>Dividing the unique branch length by the observed branch length tells you what fraction of the total observed branch length is unique to one of the samples. The more of the branch length that is unique to one of the samples, the more different the samples are from one another. This value is the Unweighted UniFrac distance <a class="reference internal" href="#equation-unweighted-unifrac">(9.4)</a> between the pair of samples.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unweighted_unifrac</span> <span class="o">=</span> <span class="n">unique_branch_length</span> <span class="o">/</span> <span class="n">observed_branch_length</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unweighted UniFrac = Unique branch length / Observed branch length&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unweighted UniFrac = </span><span class="si">%1.2f</span><span class="s1"> / </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unique_branch_length</span><span class="p">,</span> <span class="n">observed_branch_length</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unweighted UniFrac between samples </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%1.2f</span><span class="s1">&#39;</span> <span class="o">%</span> 
            <span class="p">(</span><span class="n">sample_id1</span><span class="p">,</span> <span class="n">sample_id2</span><span class="p">,</span> <span class="n">unweighted_unifrac</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unweighted UniFrac = Unique branch length / Observed branch length
Unweighted UniFrac = 0.35 / 1.18
Unweighted UniFrac between samples 4ac2 and e375 = 0.30
</pre></div>
</div>
</div>
</div>
<p>Computing Unweighted UniFrac between all pairs of the samples in the feature table results in the following distance matrix:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unweighted_unifrac_1a</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">beta_phylogenetic</span><span class="p">(</span>
                                         <span class="n">rarefied_feature_table_1a</span><span class="p">,</span> 
                                         <span class="n">tree_1a</span><span class="p">,</span> 
                                         <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;unweighted_unifrac&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distance_matrix</span>
<span class="n">unweighted_unifrac_1</span> <span class="o">=</span> <span class="n">unweighted_unifrac_1a</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">skbio</span><span class="o">.</span><span class="n">DistanceMatrix</span><span class="p">)</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
<span class="n">unweighted_unifrac_1</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
</style><table id="T_394699e4_9c9b_11eb_92b9_000d3a543a7d" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >4ac2</th>        <th class="col_heading level0 col1" >e375</th>        <th class="col_heading level0 col2" >4gd8</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_394699e4_9c9b_11eb_92b9_000d3a543a7dlevel0_row0" class="row_heading level0 row0" >4ac2</th>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow0_col0" class="data row0 col0" >0.00</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow0_col1" class="data row0 col1" >0.30</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow0_col2" class="data row0 col2" >0.71</td>
            </tr>
            <tr>
                        <th id="T_394699e4_9c9b_11eb_92b9_000d3a543a7dlevel0_row1" class="row_heading level0 row1" >e375</th>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow1_col0" class="data row1 col0" >0.30</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow1_col1" class="data row1 col1" >0.00</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow1_col2" class="data row1 col2" >0.74</td>
            </tr>
            <tr>
                        <th id="T_394699e4_9c9b_11eb_92b9_000d3a543a7dlevel0_row2" class="row_heading level0 row2" >4gd8</th>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow2_col0" class="data row2 col0" >0.71</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow2_col1" class="data row2 col1" >0.74</td>
                        <td id="T_394699e4_9c9b_11eb_92b9_000d3a543a7drow2_col2" class="data row2 col2" >0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition-video admonition">
<p class="admonition-title">Video</p>
<p>In <a class="reference external" href="https://www.youtube.com/watch?v=NfbXrJ1N_40">this video</a> I work through computing Jaccard, Bray-Curtis, and Unweighted UniFrac distance by hand.</p>
</div>
</div>
</div>
</div>
<div class="section" id="weighted-unifrac-distance">
<h3><span class="section-number">9.1.4. </span>Weighted UniFrac distance<a class="headerlink" href="#weighted-unifrac-distance" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="interpreting-distance-matrices">
<h2><span class="section-number">9.2. </span>Interpreting distance matrices<a class="headerlink" href="#interpreting-distance-matrices" title="Permalink to this headline">¶</a></h2>
<p>In the previous section we computed distance matrices that contained the pairwise distances between a few samples. You can look at those distance matrices and get a pretty good feeling for what the patterns are. For example, what are the most similar samples? What are the most dissimilar samples?</p>
<p>What if instead of three samples though, we had more. Here’s a screenshot from a distance matrix containing data on 105 samples (this is just the first few rows and columns):</p>
<p>&lt;img src=’<a class="reference external" href="https://raw.githubusercontent.com/gregcaporaso/An-Introduction-To-Applied-Bioinformatics/master/book/applications/images/example_big_dm.png">https://raw.githubusercontent.com/gregcaporaso/An-Introduction-To-Applied-Bioinformatics/master/book/applications/images/example_big_dm.png</a>’, width=800&gt;</p>
<p>Do you have a good feeling for the patterns here? What are the most similar samples? What are the most dissimilar samples?</p>
<p>Chances are, you can’t just squint at that table and understand what’s going on (but if you can, I’m hiring!). The problem is exacerbated by the fact that in modern microbial ecology studies we may have thousands or tens of thousands of samples, not “just” hundreds as in the table above. We need tools to help us take these raw distances and convert them into something that we can interpret. In this section we’ll look at some techniques, one of which we’ve covered previously, that will help us interpret large distance matrices.</p>
<hr>
<p>One excellent paper that includes a comparison of several different strategies for interpreting beta diversity results is <a class="reference external" href="https://www.sciencemag.org/content/326/5960/1694.full">Costello <em>et al.</em> Science (2009) Bacterial Community Variation in Human Body Habitats Across Space and Time</a>. In this study, the authors collected microbiome samples from 7 human subjects at about 25 sites on their bodies, at four different points in time.</p>
<p>Figure 1 shows several different approaches for comparing the resulting UniFrac distance matrix (this image is linked from the <em>Science</em> journal website - copyright belongs to <em>Science</em>):</p>
<img src="https://www.sciencemag.org/content/326/5960/1694/F1.large.jpg" width=800>
<p>Let’s generate a small distance matrix representing just a few of these body sites, and figure out how we’d generate and interpret each of these visualizations. The values in the distance matrix below are a subset of the unweighted UniFrac distance matrix representing two samples each from three body sites from the Costello <em>et al.</em> (2009) study.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;body site&#39;</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_md</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;gut&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 1&#39;</span><span class="p">],</span>
<span class="gp">... </span>       <span class="p">[</span><span class="s1">&#39;gut&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 2&#39;</span><span class="p">],</span>
<span class="gp">... </span>       <span class="p">[</span><span class="s1">&#39;tongue&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 1&#39;</span><span class="p">],</span>
<span class="gp">... </span>       <span class="p">[</span><span class="s1">&#39;tongue&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 2&#39;</span><span class="p">],</span>
<span class="gp">... </span>       <span class="p">[</span><span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 1&#39;</span><span class="p">],</span>
<span class="gp">... </span>       <span class="p">[</span><span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;subject 2&#39;</span><span class="p">]]</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">human_microbiome_sample_md</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_md</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">_columns</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">human_microbiome_sample_md</span>
<span class="go">  body site individual</span>
<span class="go">A       gut  subject 1</span>
<span class="go">B       gut  subject 2</span>
<span class="go">C    tongue  subject 1</span>
<span class="go">D    tongue  subject 2</span>
<span class="go">E      skin  subject 1</span>
<span class="go">F      skin  subject 2</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dm_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="p">[</span><span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="p">[</span><span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
<span class="gp">... </span>                    <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">]])</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">human_microbiome_dm</span> <span class="o">=</span> <span class="n">DistanceMatrix</span><span class="p">(</span><span class="n">dm_data</span><span class="p">,</span> <span class="n">sample_ids</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="p">)</span>
<span class="go">6x6 distance matrix</span>
<span class="go">IDs:</span>
<span class="go">&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;</span>
<span class="go">Data:</span>
<span class="go">[[ 0.    0.35  0.83  0.83  0.9   0.9 ]</span>
<span class="go"> [ 0.35  0.    0.86  0.85  0.92  0.91]</span>
<span class="go"> [ 0.83  0.86  0.    0.25  0.88  0.87]</span>
<span class="go"> [ 0.83  0.85  0.25  0.    0.88  0.88]</span>
<span class="go"> [ 0.9   0.92  0.88  0.88  0.    0.5 ]</span>
<span class="go"> [ 0.9   0.91  0.87  0.88  0.5   0.  ]]</span>
</pre></div>
</div>
<div class="section" id="distribution-plots-and-comparisons">
<h3><span class="section-number">9.2.1. </span>Distribution plots and comparisons<a class="headerlink" href="#distribution-plots-and-comparisons" title="Permalink to this headline">¶</a></h3>
<p>First, let’s look at the analysis presented in panels E and F. Instead of generating bar plots here, we’ll generate box plots as these are more informative (i.e., they provide a more detailed summary of the distribution being investigated). One important thing to notice here is the central role that the sample metadata plays in the visualization. If we just had our sample ids (i.e., letters <code class="docutils literal notranslate"><span class="pre">A</span></code> through <code class="docutils literal notranslate"><span class="pre">F</span></code>) we wouldn’t be able to group distances into <em>within</em> and <em>between</em> sample type categories, and we therefore couldn’t perform the comparisons we’re interested in.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">within_between_category_distributions</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">md_category</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">within_category_distances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="n">between_category_distances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_id1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">sample_md1</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">md_category</span><span class="p">][</span><span class="n">sample_id1</span><span class="p">]</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">sample_id2</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">ids</span><span class="p">[:</span><span class="n">i</span><span class="p">]:</span>
<span class="gp">... </span>            <span class="n">sample_md2</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">md_category</span><span class="p">][</span><span class="n">sample_id2</span><span class="p">]</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="n">sample_md1</span> <span class="o">==</span> <span class="n">sample_md2</span><span class="p">:</span>
<span class="gp">... </span>                <span class="n">within_category_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">sample_id1</span><span class="p">,</span> <span class="n">sample_id2</span><span class="p">])</span>
<span class="gp">... </span>            <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>                <span class="n">between_category_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">sample_id1</span><span class="p">,</span> <span class="n">sample_id2</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">within_category_distances</span><span class="p">,</span> <span class="n">between_category_distances</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">within_category_distances</span><span class="p">,</span> <span class="n">between_category_distances</span> <span class="o">=</span> <span class="n">within_between_category_distributions</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="p">,</span> <span class="n">human_microbiome_sample_md</span><span class="p">,</span> <span class="s2">&quot;body site&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">within_category_distances</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">between_category_distances</span><span class="p">)</span>
<span class="go">[0.34999999999999998, 0.25, 0.5]</span>
<span class="go">[0.82999999999999996, 0.85999999999999999, 0.82999999999999996, 0.84999999999999998, 0.90000000000000002, 0.92000000000000004, 0.88, 0.88, 0.90000000000000002, 0.91000000000000003, 0.87, 0.88]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">within_category_distances</span><span class="p">,</span> <span class="n">between_category_distances</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;same body habitat&#39;</span><span class="p">,</span> <span class="s1">&#39;different body habitat&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Unweighted UniFrac Distance&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="go">&lt;Figure size 432x288 with 1 Axes&gt;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">skbio.stats.distance</span> <span class="kn">import</span> <span class="n">anosim</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">anosim</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="p">,</span> <span class="n">human_microbiome_sample_md</span><span class="p">,</span> <span class="s1">&#39;body site&#39;</span><span class="p">)</span>
<span class="go">method name               ANOSIM</span>
<span class="go">test statistic name            R</span>
<span class="go">sample size                    6</span>
<span class="go">number of groups               3</span>
<span class="go">test statistic                 1</span>
<span class="go">p-value                    0.065</span>
<span class="go">number of permutations       999</span>
<span class="go">Name: ANOSIM results, dtype: object</span>
</pre></div>
</div>
<p>If we run through these same steps, but base our analysis on a different metadata category where we don’t expect to see any significant clustering, you can see that we no longer get a significant result.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">within_category_distances</span><span class="p">,</span> <span class="n">between_category_distances</span> <span class="o">=</span> <span class="n">within_between_category_distributions</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="p">,</span> <span class="n">human_microbiome_sample_md</span><span class="p">,</span> <span class="s2">&quot;individual&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">within_category_distances</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">between_category_distances</span><span class="p">)</span>
<span class="go">[0.82999999999999996, 0.84999999999999998, 0.90000000000000002, 0.88, 0.91000000000000003, 0.88]</span>
<span class="go">[0.34999999999999998, 0.85999999999999999, 0.82999999999999996, 0.25, 0.92000000000000004, 0.88, 0.90000000000000002, 0.87, 0.5]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">within_category_distances</span><span class="p">,</span> <span class="n">between_category_distances</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;same person&#39;</span><span class="p">,</span> <span class="s1">&#39;different person&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Unweighted UniFrac Distance&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="go">&lt;Figure size 432x288 with 1 Axes&gt;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">anosim</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="p">,</span> <span class="n">human_microbiome_sample_md</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">)</span>
<span class="go">method name                 ANOSIM</span>
<span class="go">test statistic name              R</span>
<span class="go">sample size                      6</span>
<span class="go">number of groups                 2</span>
<span class="go">test statistic           -0.333333</span>
<span class="go">p-value                      0.869</span>
<span class="go">number of permutations         999</span>
<span class="go">Name: ANOSIM results, dtype: object</span>
</pre></div>
</div>
<p>Why do you think the distribution of distances between people has a greater range than the distribution of distances within people in this particular example?</p>
<p>Here we used ANOSIM testing whether our with and between category groups differ. This test is specifically designed for distance matrices, and it accounts for the fact that the values are not independent of one another. For example, if one of our samples was very different from all of the others, all of the distances associated with that sample would be large. It’s very important to choose the appropriate statistical test to use. One free resource for helping you do that is <a class="reference external" href="http://mb3is.megx.net/gustame"><em>The Guide to Statistical Analysis in Microbial Ecology (GUSTAME)</em></a>. If you’re getting started in microbial ecology, I recommend spending some time studying GUSTAME.</p>
</div>
<div class="section" id="hierarchical-clustering">
<h3><span class="section-number">9.2.2. </span>Hierarchical clustering<a class="headerlink" href="#hierarchical-clustering" title="Permalink to this headline">¶</a></h3>
<p>Next, let’s look at a hierarchical clustering analysis, similar to that presented in panel G above. Here I’m applying the UPGMA functionality implemented in <a class="reference external" href="http://www.scipy.org/scipylib/index.html">SciPy</a> to generate a tree which we visualize with a dendrogram. However the tips in this tree don’t represent sequences or OTUs, but instead they represent samples, and samples with a smaller branch length between them are more similar in composition than samples with a longer branch length between them. (Remember that only horizontal branch length is counted - vertical branch length is just to aid in the organization of the dendrogram.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">average</span><span class="p">,</span> <span class="n">dendrogram</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">lm</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">human_microbiome_dm</span><span class="o">.</span><span class="n">condensed_form</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">dendrogram</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">human_microbiome_dm</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="go">&lt;Figure size 432x288 with 1 Axes&gt;</span>
</pre></div>
</div>
<p>Again, we can see how the data really only becomes interpretable in the context of metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">human_microbiome_sample_md</span><span class="p">[</span><span class="s1">&#39;body site&#39;</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sample_ids</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">dendrogram</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="go">&lt;Figure size 432x288 with 1 Axes&gt;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">human_microbiome_sample_md</span><span class="p">[</span><span class="s1">&#39;individual&#39;</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sample_ids</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">dendrogram</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">link_color_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="go">&lt;Figure size 432x288 with 1 Axes&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="ordination">
<h3><span class="section-number">9.2.3. </span>Ordination<a class="headerlink" href="#ordination" title="Permalink to this headline">¶</a></h3>
<p>Finally, let’s look at ordination, similar to that presented in panels A-D. The basic idea behind ordination is dimensionality reduction: we want to take high-dimensionality data (a distance matrix) and represent that in a few (usually two or three) dimensions. As humans, we’re very bad at interpreting high dimensionality data directly: with ordination, we can take an <span class="math notranslate nohighlight">\(n\)</span>-dimensional data set (e.g., a distance matrix of shape <span class="math notranslate nohighlight">\(n \times n\)</span>, representing the distances between <span class="math notranslate nohighlight">\(n\)</span> biological samples) and reduce that to a 2-dimensional scatter plot similar to that presented in panels A-D above.</p>
<p>Ordination is a technique that is widely applied in ecology and in bioinformatics, but the math behind some of the methods such as <em>Principal Coordinates Analysis</em> is fairly complex, and as a result I’ve found that these methods are a black box for a lot of people. Possibly the most simple ordination technique is one called Polar Ordination. Polar Ordination is not widely applied because it has some inconvenient features, but I find that it is useful for introducing the idea behind ordination. Here we’ll work through a simple implementation of ordination to illustrate the process, which will help us to interpret ordination plots. In practice, you will use existing software, such as <a class="reference external" href="http://scikit-bio.org">scikit-bio</a>’s <a class="reference external" href="http://scikit-bio.org/maths.stats.ordination.html">ordination module</a>.</p>
<p>An excellent site for learning more about ordination is <a class="reference external" href="http://ordination.okstate.edu/">Michael W. Palmer’s Ordination Methods page</a>.</p>
</div>
</div>
<div class="section" id="list-of-works-cited">
<h2><span class="section-number">9.3. </span>List of works cited<a class="headerlink" href="#list-of-works-cited" title="Permalink to this headline">¶</a></h2>
<p id="id3"><dl class="citation">
<dt class="label" id="id27"><span class="brackets"><a class="fn-backref" href="#id2">LK05</a></span></dt>
<dd><p>Catherine Lozupone and Rob Knight. UniFrac: a new phylogenetic method for comparing microbial communities. <em>Appl. Environ. Microbiol.</em>, 71(12):8228–8235, December 2005.</p>
</dd>
</dl>
</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./using"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="alpha-diversity.html" title="previous page"><span class="section-number">8. </span>Alpha diversity</a>
    <a class='right-next' id="next-link" href="feature-table-normalization.html" title="next page"><span class="section-number">10. </span>Normalization of Feature Tables</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By J Gregory Caporaso<br/>
        
            &copy; Copyright 2020-2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'G-KZHV37SG3H', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>